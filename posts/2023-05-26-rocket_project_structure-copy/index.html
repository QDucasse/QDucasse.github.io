<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.97.3" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Quentin Ducasse" />
  <meta property="og:url" content="https://qducasse.github.io/posts/2023-05-26-rocket_project_structure-copy/" />
  <link rel="canonical" href="https://qducasse.github.io/posts/2023-05-26-rocket_project_structure-copy/" /><link rel="alternate" type="application/atom+xml" href="https://qducasse.github.ioindex.xml" title="Lectern">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/qducasse.github.io"
      },
      "articleSection" : "posts",
      "name" : "Rocket chip structure",
      "headline" : "Rocket chip structure",
      "description" : "Rocket core structure and exploration The objective here is to get a feeling of how things are defined in the rocket chip generator. I will look at the files in src\/main\/scala\/rocket for the latest release 1.6:\nLogic:\n ALU.scala: Arithmetic logical unit - performs all base operations. AMOALU.scala: Atomic memory operation ALU - performs all atomic memory operations. Breakpoint.scala: Breakpoint utilities BTB.scala: Branch target buffer - predicts branch targets Decode.scala: Decoder - applies the bit patterns defined in IDecode Events.",
      "inLanguage" : "en-US",
      "author" : "Quentin Ducasse",
      "creator" : "Quentin Ducasse",
      "publisher": "Quentin Ducasse",
      "accountablePerson" : "Quentin Ducasse",
      "copyrightHolder" : "Quentin Ducasse",
      "copyrightYear" : "2023",
      "datePublished": "2023-05-26 00:00:00 \u002b0000 UTC",
      "dateModified" : "2023-05-26 00:00:00 \u002b0000 UTC",
      "url" : "https:\/\/qducasse.github.io\/posts\/2023-05-26-rocket_project_structure-copy\/",
      "keywords" : [ "riscv","rocket", ]
  }
</script>
<title>Rocket chip structure</title>
  <meta property="og:title" content="Rocket chip structure" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="Rocket core structure and exploration The objective here is to get a feeling of how things are defined in the rocket chip generator. I will look at the files in src/main/scala/rocket for the latest release 1.6:
Logic:
 ALU.scala: Arithmetic logical unit - performs all base operations. AMOALU.scala: Atomic memory operation ALU - performs all atomic memory operations. Breakpoint.scala: Breakpoint utilities BTB.scala: Branch target buffer - predicts branch targets Decode.scala: Decoder - applies the bit patterns defined in IDecode Events." />
  <meta name="description" content="Rocket core structure and exploration The objective here is to get a feeling of how things are defined in the rocket chip generator. I will look at the files in src/main/scala/rocket for the latest release 1.6:
Logic:
 ALU.scala: Arithmetic logical unit - performs all base operations. AMOALU.scala: Atomic memory operation ALU - performs all atomic memory operations. Breakpoint.scala: Breakpoint utilities BTB.scala: Branch target buffer - predicts branch targets Decode.scala: Decoder - applies the bit patterns defined in IDecode Events." />
  <meta property="og:locale" content="en" /><meta property="og:image" content="" />
  

  
    <style>body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:1000px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{margin:0;padding:0 1em;color:#57606a;border-left:.25em solid #d0d7de}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;font-size:100%;background-color:inherit;border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{text-align:center}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}</style>
  
  
    <style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style>
  

  

  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="Lectern">
  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel="stylesheet">
  
  

  
  
</head>


<body>
  <article class="post " id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="header-title">
    <a href="/"
      >Lectern</a
    >
  </div>
  <div class="header-subtitle">Notes and Memos, Quentin DUCASSE</div>
</header>
<div class="row end-md center-xs header-items">
  
  <div class="header-item">
    <a href="https://github.com/QDucasse" target="_blank">Github</a>
  </div>
  
  <div class="header-item">
    <a href="https://twitter.com/quentin_ducasse" target="_blank">Twitter</a>
  </div>
  
</div>
<div class="row end-xs">
   
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">Rocket chip structure</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2023-05-26 00:00:00 UTC">
                26 May 2023
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="">@Quentin Ducasse</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <h2 id="rocket-core-structure-and-exploration">Rocket core structure and exploration</h2>
<p>The objective here is to get a feeling of how things are defined in the <a href="https://github.com/chipsalliance/rocket-chip">rocket chip generator</a>. I will look at the files in <a href="https://github.com/chipsalliance/rocket-chip/tree/master/src/main/scala/rocket"><code>src/main/scala/rocket</code></a> for the latest release 1.6:</p>
<p><strong>Logic</strong>:</p>
<ul>
<li><code>ALU.scala</code>: Arithmetic logical unit - performs all base operations.</li>
<li><code>AMOALU.scala</code>: Atomic memory operation ALU - performs all atomic memory operations.</li>
<li><code>Breakpoint.scala</code>: Breakpoint utilities</li>
<li><code>BTB.scala</code>: Branch target buffer - predicts branch targets</li>
<li><code>Decode.scala</code>: Decoder - applies the bit patterns defined in <code>IDecode</code></li>
<li><code>Events.scala</code>: Events - assess performance or trace using a given mask</li>
<li><code>Frontend.scala</code>: Used by the C++ emulator</li>
<li><code>IBuf.scala</code>: Instruction buffer -</li>
<li><code>ICache.scala</code>: (L1?) Instruction cache - program store</li>
<li><code>IDecode.scala</code>: Instruction decoder - links bit patterns from instructions to infos</li>
<li><code>Multiplier.scala</code>: Multiplication and division unit</li>
<li><code>RocketCore.scala</code>: Rocket definition - all internal signals and module instantiations</li>
<li><code>RVC.scala</code>: RVC decoder - RV compressed instructions handling</li>
</ul>
<p><strong>Memory</strong>:</p>
<ul>
<li><code>DCache.scala</code>: (L1?) data cache</li>
<li><code>NBDcache.scala</code>: Non-blocking (L1?) data cache</li>
<li><code>HellaCacheArbiter.scala</code>: Arbiter for data cache - controls requests from the core, RoCC, FPU or PTW</li>
<li><code>HellaCache.scala</code>: L1 Cache - defines cache parameters and traits</li>
<li><code>SimpleHellaCacheIF.scala</code>:</li>
<li><code>TLB.scala</code>: Translation lookaside buffer</li>
<li><code>TLBPermissions.scala</code>:</li>
<li><code>PMP.scala</code>: Physical memory protection - defines the CSRs and checker</li>
<li><code>PTW.scala</code>: Page table walker</li>
<li><code>ScratchpadSlavePort.scala</code>: IO conversion - adapts between diplomacy (<code>TileLink</code>) and non-diplomacy (<code>HellaCacheIO</code>)</li>
</ul>
<p><strong>Constants</strong>:</p>
<ul>
<li><code>Consts.scala</code>: Main constants used throughout the core definition</li>
<li><code>CSR.scala</code>: Control and status registers</li>
<li><code>CustomInstructions.scala</code>: Custom(0-3) instructions encoding and CSRs</li>
<li><code>Instructions32.scala</code>: RV32 specific instructions Encoding</li>
<li><code>Instructions.scala</code>: Instructions encodings, causes, and CSRs</li>
</ul>
<h2 id="diving-in-the-rocketcore">Diving in the <code>RocketCore</code></h2>
<p>The <a href="https://github.com/chipsalliance/rocket-chip/tree/master/src/main/scala/rocket/RocketCore.scala"><code>RocketCore.scala</code></a> file defines the inner pipeline of the Rocket CPU along with its IOs. It defines the main class, <code>Rocket</code>, and its parameters:</p>
<blockquote>
<p><em>Note:</em> All core IOs are grouped after the pipeline and should be looked into to see the impact of a stage on the IOs!</p>
</blockquote>
<ol>
<li><strong>Performance Events:</strong> The first definitions are performance events to record the usage of given instructions, cache information, and branch prediction accuracy.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">EventSet</span><span style="color:#f92672">((</span>mask<span style="color:#f92672">,</span> hits<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Mux</span><span style="color:#f92672">(</span>wb_xcpt<span style="color:#f92672">,</span> mask<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">),</span> wb_valid <span style="color:#f92672">&amp;&amp;</span> pipelineIDToWB<span style="color:#f92672">((</span>mask <span style="color:#f92672">&amp;</span> hits<span style="color:#f92672">).</span>orR<span style="color:#f92672">)),</span> <span style="color:#a6e22e">Seq</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* Instructions */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;exception&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">.</span>B<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;load&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> id_ctrl<span style="color:#f92672">.</span>mem <span style="color:#f92672">&amp;&amp;</span> id_ctrl<span style="color:#f92672">.</span>mem_cmd <span style="color:#f92672">===</span> <span style="color:#a6e22e">M_XRD</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>id_ctrl<span style="color:#f92672">.</span>fp<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;store&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> id_ctrl<span style="color:#f92672">.</span>mem <span style="color:#f92672">&amp;&amp;</span> id_ctrl<span style="color:#f92672">.</span>mem_cmd <span style="color:#f92672">===</span> <span style="color:#a6e22e">M_XWR</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>id_ctrl<span style="color:#f92672">.</span>fp<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;system&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> id_ctrl<span style="color:#f92672">.</span>csr <span style="color:#f92672">=/=</span> <span style="color:#a6e22e">CSR</span><span style="color:#f92672">.</span>N<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;branch&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> id_ctrl<span style="color:#f92672">.</span>branch<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* Interlocks and branches */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;long-latency interlock&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> id_sboard_hazard<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;I$ blocked&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> icache_blocked<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;D$ blocked&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> id_ctrl<span style="color:#f92672">.</span>mem <span style="color:#f92672">&amp;&amp;</span> dcache_blocked<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;branch misprediction&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> take_pc_mem <span style="color:#f92672">&amp;&amp;</span> mem_direction_misprediction<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;flush&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> wb_reg_flush_pipe<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;replay&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> replay_wb<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* Cache misses */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;I$ miss&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> io<span style="color:#f92672">.</span>imem<span style="color:#f92672">.</span>perf<span style="color:#f92672">.</span>acquire<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;D$ miss&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> io<span style="color:#f92672">.</span>dmem<span style="color:#f92672">.</span>perf<span style="color:#f92672">.</span>acquire<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;D$ release&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> io<span style="color:#f92672">.</span>dmem<span style="color:#f92672">.</span>perf<span style="color:#f92672">.</span>release<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ITLB miss&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> io<span style="color:#f92672">.</span>imem<span style="color:#f92672">.</span>perf<span style="color:#f92672">.</span>tlbMiss<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;DTLB miss&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> io<span style="color:#f92672">.</span>dmem<span style="color:#f92672">.</span>perf<span style="color:#f92672">.</span>tlbMiss<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;L2 TLB miss&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> io<span style="color:#f92672">.</span>ptw<span style="color:#f92672">.</span>perf<span style="color:#f92672">.</span>l2miss<span style="color:#f92672">))</span>
</span></span></code></pre></div><ol start="2">
<li><strong>Decode Modules:</strong> The decode modules are set up by adding them all to a common <code>decode_table</code> flattening their dictionaries.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> decode_table <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    require<span style="color:#f92672">(!</span>usingRoCC <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>rocketParams<span style="color:#f92672">.</span>useSCIE<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>usingRoCC<span style="color:#f92672">.</span>option<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RoCCDecode</span><span style="color:#f92672">))</span> <span style="color:#f92672">++:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>rocketParams<span style="color:#f92672">.</span>useSCIE<span style="color:#f92672">.</span>option<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SCIEDecode</span><span style="color:#f92672">))</span> <span style="color:#f92672">++:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>xLen <span style="color:#f92672">==</span> <span style="color:#ae81ff">32</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">new</span> I32Decode <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">new</span> I64Decode<span style="color:#f92672">)</span> <span style="color:#f92672">+:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Seq</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FenceIDecode</span><span style="color:#f92672">(</span>tile<span style="color:#f92672">.</span>dcache<span style="color:#f92672">.</span>flushOnFenceI<span style="color:#f92672">))</span> <span style="color:#f92672">++:</span>
</span></span><span style="display:flex;"><span>    coreParams<span style="color:#f92672">.</span>haveCFlush<span style="color:#f92672">.</span>option<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">CFlushDecode</span><span style="color:#f92672">(</span>tile<span style="color:#f92672">.</span>dcache<span style="color:#f92672">.</span>canSupportCFlushLine<span style="color:#f92672">))</span> <span style="color:#f92672">++:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Seq</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">IDecode</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> flatMap<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>table<span style="color:#f92672">)</span>
</span></span></code></pre></div><ol start="3">
<li>
<p><strong>Signal definitions:</strong> All the signals used throughout the core are defined here with a prefix corresponding to their pipeline stage: <code>id</code> for <em>instruction decode</em>, <code>ex</code> for <em>execute</em>, <code>mem</code> for <em>memory</em>, and <code>wb</code> for <em>writeback</em>.</p>
</li>
<li>
<p><strong>Decode stage:</strong> The decode stage instantiates an <code>IBuf</code> (Instruction Buffer) and runs the raw instruction against its decoders. An instruction is defined as a bit pattern of important bits and don&rsquo;t-cares, effectively defining a bit mask:</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#75715e">// in Instructions.scala
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ADD</span>     <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">BitPat</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;b0000000??????????000?????0110011&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ADD_UW</span>  <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">BitPat</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;b0000100??????????000?????0111011&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ADDI</span>    <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">BitPat</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;b?????????????????000?????0010011&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>These bit patterns are used as keys in the decoder, matching them with control signals, <code>IntCtrlSigs</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#75715e">// in IDecode.scala
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IntCtrlSigs</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Bundle</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> default<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">List</span><span style="color:#f92672">[</span><span style="color:#66d9ef">BitPat</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//           jal                                                             renf1               fence.i
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   val     | jalr                                                          | renf2             |
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   | fp_val| | renx2                                                       | | renf3           |
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   | | rocc| | | renx1       s_alu1                          mem_val       | | | wfd           |
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   | | | br| | | |   s_alu2  |       imm    dw     alu       | mem_cmd     | | | | mul         |
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   | | | | | | | |   |       |       |      |      |         | |           | | | | | div       | fence
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   | | | | | | | |   |       |       |      |      |         | |           | | | | | | wxd     | | amo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   | | | | | | | | scie      |       |      |      |         | |           | | | | | | |       | | | dp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">List</span><span style="color:#f92672">(</span>N<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>A2_X<span style="color:#f92672">,</span>   A1_X<span style="color:#f92672">,</span>   <span style="color:#a6e22e">IMM_X</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DW_X</span><span style="color:#f92672">,</span>  <span style="color:#a6e22e">FN_X</span><span style="color:#f92672">,</span>     N<span style="color:#f92672">,</span><span style="color:#a6e22e">M_X</span><span style="color:#f92672">,</span>        X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span><span style="color:#a6e22e">CSR</span><span style="color:#f92672">.</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">,</span>X<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IDecode</span><span style="color:#f92672">(</span><span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">val</span> p<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Parameters</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">DecodeConstants</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> table<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">BitPat</span>, <span style="color:#66d9ef">List</span><span style="color:#f92672">[</span><span style="color:#66d9ef">BitPat</span><span style="color:#f92672">])]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Array</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">BNE</span><span style="color:#f92672">-&gt;</span>       <span style="color:#a6e22e">List</span><span style="color:#f92672">(</span>Y<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>Y<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>Y<span style="color:#f92672">,</span>Y<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>A2_RS2<span style="color:#f92672">,</span>A1_RS1<span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>                     <span style="color:#a6e22e">IMM_SB</span><span style="color:#f92672">,</span>  <span style="color:#a6e22e">DW_X</span><span style="color:#f92672">,</span><span style="color:#a6e22e">FN_SNE</span><span style="color:#f92672">,</span>  N<span style="color:#f92672">,</span><span style="color:#a6e22e">M_X</span><span style="color:#f92672">,</span>        
</span></span><span style="display:flex;"><span>                     N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span><span style="color:#a6e22e">CSR</span><span style="color:#f92672">.</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">BEQ</span><span style="color:#f92672">-&gt;</span>       <span style="color:#a6e22e">List</span><span style="color:#f92672">(</span>Y<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>Y<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>Y<span style="color:#f92672">,</span>Y<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>A2_RS2<span style="color:#f92672">,</span>A1_RS1<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#a6e22e">IMM_SB</span><span style="color:#f92672">,</span>  <span style="color:#a6e22e">DW_X</span><span style="color:#f92672">,</span><span style="color:#a6e22e">FN_SEQ</span><span style="color:#f92672">,</span>   N<span style="color:#f92672">,</span><span style="color:#a6e22e">M_X</span><span style="color:#f92672">,</span>        
</span></span><span style="display:flex;"><span>                     N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span><span style="color:#a6e22e">CSR</span><span style="color:#f92672">.</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">,</span>N<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">)</span>    
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>This <code>id_ctrl</code> signal contains high-level information for each instruction such as if it needs memory access, which ALU function to trigger, etc.</p>
<ol start="5">
<li><strong>Execute stage:</strong> The execute stage instantiates an ALU and passes the decoded parameters. It can also run a multiplication/division through its dedicated unit:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">val</span> alu <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Module</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ALU</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>alu<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>dw <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_ctrl<span style="color:#f92672">.</span>alu_dw
</span></span><span style="display:flex;"><span>alu<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>fn <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_ctrl<span style="color:#f92672">.</span>alu_fn
</span></span><span style="display:flex;"><span>alu<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>in2 <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_op2<span style="color:#f92672">.</span>asUInt
</span></span><span style="display:flex;"><span>alu<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>in1 <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_op1<span style="color:#f92672">.</span>asUInt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// multiplier and divider
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> div <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Module</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MulDiv</span><span style="color:#f92672">(</span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pipelinedMul<span style="color:#f92672">)</span> mulDivParams<span style="color:#f92672">.</span>copy<span style="color:#f92672">(</span>mulUnroll <span style="color:#66d9ef">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">else</span> mulDivParams<span style="color:#f92672">,</span> width <span style="color:#66d9ef">=</span> xLen<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>div<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>valid <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_reg_valid <span style="color:#f92672">&amp;&amp;</span> ex_ctrl<span style="color:#f92672">.</span>div
</span></span><span style="display:flex;"><span>div<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>bits<span style="color:#f92672">.</span>dw <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_ctrl<span style="color:#f92672">.</span>alu_dw
</span></span><span style="display:flex;"><span>div<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>bits<span style="color:#f92672">.</span>fn <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_ctrl<span style="color:#f92672">.</span>alu_fn
</span></span><span style="display:flex;"><span>div<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>bits<span style="color:#f92672">.</span>in1 <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_rs<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>div<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>bits<span style="color:#f92672">.</span>in2 <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_rs<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>div<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>bits<span style="color:#f92672">.</span>tag <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_waddr
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">val</span> mul <span style="color:#66d9ef">=</span> pipelinedMul<span style="color:#f92672">.</span>option <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">val</span> m <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Module</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">PipelinedMultiplier</span><span style="color:#f92672">(</span>xLen<span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>m<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>valid <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_reg_valid <span style="color:#f92672">&amp;&amp;</span> ex_ctrl<span style="color:#f92672">.</span>mul
</span></span><span style="display:flex;"><span>m<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>bits <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> div<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>bits
</span></span><span style="display:flex;"><span>m
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ol start="6">
<li>
<p><strong>Memory stage:</strong> The memory stage extracts the branch targets, and transfers the control signals to the next stage. The signals are used in the instruction memory through the Branch Target Buffer (BTB). Note that single-cycle latency instructions simply have their results forwarded to the next stage. This forwarding ensures that both one- and two-cycle instructions always write their results in the same stage of the pipeline so that just one write port to the register file can be used, and it is always available.</p>
</li>
<li>
<p><strong>Writeback stage:</strong> The writeback stage writes the result of the operations in the register file.</p>
</li>
<li>
<p><strong>IOs:</strong> Other signals put at the end interact with the IOs of the core:</p>
</li>
</ol>
<ul>
<li>CSR update</li>
<li>Instruction memory update</li>
<li>PTW update</li>
<li>Data memory update</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#75715e">// Data memory request from the execute stage
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  io<span style="color:#f92672">.</span>dmem<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>bits<span style="color:#f92672">.</span>tag  <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_dcache_tag
</span></span><span style="display:flex;"><span>  io<span style="color:#f92672">.</span>dmem<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>bits<span style="color:#f92672">.</span>cmd  <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_ctrl<span style="color:#f92672">.</span>mem_cmd
</span></span><span style="display:flex;"><span>  io<span style="color:#f92672">.</span>dmem<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>bits<span style="color:#f92672">.</span>size <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> ex_reg_mem_size 
</span></span><span style="display:flex;"><span>  io<span style="color:#f92672">.</span>dmem<span style="color:#f92672">.</span>req<span style="color:#f92672">.</span>bits<span style="color:#f92672">.</span>signed <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">Mux</span><span style="color:#f92672">(</span>ex_reg_hls<span style="color:#f92672">,</span> ex_reg_inst<span style="color:#f92672">(</span><span style="color:#ae81ff">20</span><span style="color:#f92672">),</span> ex_reg_inst<span style="color:#f92672">(</span><span style="color:#ae81ff">14</span><span style="color:#f92672">))</span>
</span></span></code></pre></div><h2 id="integrating-rocket-in-a-rockettile">Integrating <code>Rocket</code> in a <code>RocketTile</code></h2>
<p>The IOs presented earlier are needed to define the Rocket core with its peripherals. The so-called <em>tiles</em> are defined in <a href="https://github.com/chipsalliance/rocket-chip/tree/master/src/main/scala/tile"><code>src/main/scala/tile</code></a>. The <a href="https://github.com/chipsalliance/rocket-chip/tree/master/src/main/scala/tile/RocketTile.scala"><code>RocketTile</code></a>, extending <a href="https://github.com/chipsalliance/rocket-chip/tree/master/src/main/scala/tile/BaseTile.scala"><code>BaseTile</code></a> presents the integration of the <code>Rocket</code> core along its peripherals:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RocketTileModuleImp</span><span style="color:#f92672">(</span>outer<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RocketTile</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">BaseTileModuleImp</span><span style="color:#f92672">(</span>outer<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">HasFpuOpt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">HasLazyRoCCModule</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">HasICacheFrontendModule</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Annotated</span><span style="color:#f92672">.</span>params<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> outer<span style="color:#f92672">.</span>rocketParams<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> core <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Module</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Rocket</span><span style="color:#f92672">(</span>outer<span style="color:#f92672">)(</span>outer<span style="color:#f92672">.</span>p<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>various error passing<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Connect the core pipeline to other intra-tile modules
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  outer<span style="color:#f92672">.</span>frontend<span style="color:#f92672">.</span>module<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>cpu <span style="color:#f92672">&lt;&gt;</span> core<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>imem
</span></span><span style="display:flex;"><span>  dcachePorts <span style="color:#f92672">+=</span> core<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>dmem
</span></span><span style="display:flex;"><span>  fpuOpt foreach <span style="color:#f92672">{</span> fpu <span style="color:#66d9ef">=&gt;</span> core<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>fpu <span style="color:#f92672">&lt;&gt;</span> fpu<span style="color:#f92672">.</span>io <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  core<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>ptw <span style="color:#f92672">&lt;&gt;</span> ptw<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>dpath
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Connect the coprocessor interfaces
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>outer<span style="color:#f92672">.</span>roccs<span style="color:#f92672">.</span>size <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    cmdRouter<span style="color:#f92672">.</span>get<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>in <span style="color:#f92672">&lt;&gt;</span> core<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>rocc<span style="color:#f92672">.</span>cmd
</span></span><span style="display:flex;"><span>    outer<span style="color:#f92672">.</span>roccs<span style="color:#f92672">.</span>foreach<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>module<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>exception <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> core<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>rocc<span style="color:#f92672">.</span>exception<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    core<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>rocc<span style="color:#f92672">.</span>resp <span style="color:#f92672">&lt;&gt;</span> respArb<span style="color:#f92672">.</span>get<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>out
</span></span><span style="display:flex;"><span>    core<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>rocc<span style="color:#f92672">.</span>busy <span style="color:#f92672">&lt;&gt;</span> <span style="color:#f92672">(</span>cmdRouter<span style="color:#f92672">.</span>get<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>busy <span style="color:#f92672">||</span> outer<span style="color:#f92672">.</span>roccs<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>module<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>busy<span style="color:#f92672">).</span>reduce<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">_</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    core<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>rocc<span style="color:#f92672">.</span>interrupt <span style="color:#66d9ef">:</span><span style="color:#f92672">=</span> outer<span style="color:#f92672">.</span>roccs<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>module<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>interrupt<span style="color:#f92672">).</span>reduce<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">_</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="looking-at-memory-accesses-and-the-pmp">Looking at memory accesses and the PMP</h2>
<p>Now that we have a better understanding of the project structure, pipeline, and peripherals that Rocket uses we can look more in detail at Rocket memory accesses, how they are formatted, how they are passed to the data memory, and how they are processed checked by the PMP.</p>
<ol>
<li><strong>Load/Stores instructions:</strong> In the RISC-V ISA, each instruction defines its <code>opcode</code> (bits 0-7) and might precise the <code>opcode</code> with <code>funct3</code>. In the case of loads and stores, the encoding is the following:</li>
</ol>
<pre tabindex="0"><code>LOAD - x[rd] = M[x[rs1] + sext(offset)][WIDTH]
             = sext(M[x[rs1] + sext(offset)][WIDTH]) if SGN

| 31                  20|19    15|14       12|11           7|6        0 |
|       imm [11:0]      |  rs1   |  funct3   |      rd      |  opcode   |
|         OFFSET        |   _    | SGN|WIDTH |              |  STORE    |


STORE - M[x[rs1] + sext(offset)] = x[rs2][WIDTH] 

| 31          25|24    20|19    15|14       12|11          7|6        0 |
|    imm [11:5] |  rs2   |  rs1   |  funct3   |     rd      |  opcode   |
|     OFFSET1   |        _        | _ |WIDTH  | offset[4:0] |   LOAD    |
</code></pre><p>The opcode defines the type of instruction, <code>load</code>/<code>store</code>. While the registers are different in their usage, <code>load</code>s use an offset encoded over <code>rs2</code> while <code>store</code> use <code>rs2</code> as the source register holding the data to move to memory. The <code>funct3</code> field define the width of the access with its least significant bits (12 and 13) that corresponds to: <code>00</code> for a <code>byte</code>, <code>01</code> for a <code>half-word</code> (2 bytes), <code>10</code> for a <code>word</code> (4 bytes) and <code>11</code> for a <code>double</code> (8 bytes). The bit 14 is used to differenciate signed and unsigned loads.</p>
<blockquote>
<p><em>Note:</em> unsigned store do not exist as they do not need to be sign-extended to field a register!</p>
</blockquote>

        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
            <div class="post-tags">
              <a href="/tags/riscv/">
                riscv
              </a>
            </div>
            
            <div class="post-tags">
              <a href="/tags/rocket/">
                rocket
              </a>
            </div>
            
          </div>
        </div>
        
          <div class="row">
            <div class="col-xs-12">
              
            </div>
          </div>

          

<div class="related-content">
  <h3>Related Posts</h3>
  <ul>
    
    <li><a href="/posts/2023-02-07-rocket_running_raw_binary/">Running raw binary on Rocket&#39;s emulator</a></li>
    
    <li><a href="/posts/2023-02-04-rocket_adding_a_unit_test/">Adding a unit test in Rocket</a></li>
    
    <li><a href="/posts/2023-02-02-rocket_inspecting_a_test/">Rocket test macros</a></li>
    
  </ul>
</div>



          
          
          <div style="height: 50px;"></div>
          
        

        <div class="site-footer">
  
  
</div>

      </div>
    </div>
  </article>

  

<script>
  
  
    
    
  
</script>

  

</body>

</html>