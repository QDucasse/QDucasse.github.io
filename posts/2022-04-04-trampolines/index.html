<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.97.3" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Quentin Ducasse" />
  <meta property="og:url" content="https://qducasse.github.io/posts/2022-04-04-trampolines/" />
  <link rel="canonical" href="https://qducasse.github.io/posts/2022-04-04-trampolines/" /><link rel="alternate" type="application/atom+xml" href="https://qducasse.github.ioindex.xml" title="Lectern">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/qducasse.github.io"
      },
      "articleSection" : "posts",
      "name" : "Cogit runtime trampolines",
      "headline" : "Cogit runtime trampolines",
      "description" : "Cogit trampolines cePICMissTrampoline\nceCallCogCodePopReceiverAndClassRegs\nceCallCogCodePopReceiverReg\nceCannotResumeTrampoline\nceCaptureCStackPointers\nceCheckFeaturesFunction\nceCheckForInterruptTrampoline\nceEnclosingObjectTrampoline\nceEnterCogCodePopReceiverReg\nceFetchContextInstVarTrampoline\nceFlushICache\nceFreeTrampoline\nceGetFP\nceGetSP\nceMallocTrampoline\nceMethodAbortTrampoline\nceNonLocalReturnTrampoline\ncePICAbortTrampoline\ncePrimReturnEnterCogCode\ncePrimReturnEnterCogCodeProfiling\nceReapAndResetErrorCodeTrampoline\nceReturnToInterpreterTrampoline\nceSendMustBeBooleanAddFalseTrampoline\nceSendMustBeBooleanAddTrueTrampoline\nceStoreContextInstVarTrampoline\nceTraceBlockActivationTrampoline\nceTraceLinkedSendTrampoline\nceTraceStoreTrampoline\nceTryLockVMOwner\nceUnlockVMOwner\nSimpleStackBasedCogit trampolines ceCPICMissTrampoline\nceCheckForInterruptTrampoline\nceEnclosingObjectTrampoline\nceFetchContextInstVarTrampoline\nceMethodAbortTrampoline\nceNonLocalReturnTrampoline\ncePICAbortTrampoline\ncePrimReturnEnterCogCode\ncePrimReturnEnterCogCodeProfiling\nceReapAndResetErrorCodeTrampoline\nceStoreContextInstVarTrampoline\nceTraceBlockActivationTrampoline\nceTraceLinkedSendTrampoline\nceTraceStoreTrampoline\nStackToRegisterMappingCogit trampolines ceEnclosingObjectTrampoline\nceFetchContextInstVarTrampoline\nceNonLocalReturnTrampoline\nceReapAndResetErrorCodeTrampoline\nceStoreContextInstVarTrampoline\nceTraceBlockActivationTrampoline\nceTraceLinkedSendTrampoline\nceTraceStoreTrampoline\nRegisterAllocatingCogit trampolines ceCheckForInterruptTrampoline\nceSendMustBeBooleanAddFalseTrampoline\nceSendMustBeBooleanAddTrueTrampoline\nTrampoline generation generateTrampolines \t\u0026#34;Generate the run-time entries and exits at the base of the native code zone and update the base.",
      "inLanguage" : "en-US",
      "author" : "Quentin Ducasse",
      "creator" : "Quentin Ducasse",
      "publisher": "Quentin Ducasse",
      "accountablePerson" : "Quentin Ducasse",
      "copyrightHolder" : "Quentin Ducasse",
      "copyrightYear" : "2022",
      "datePublished": "2022-04-04 00:00:00 \u002b0000 UTC",
      "dateModified" : "2022-04-04 00:00:00 \u002b0000 UTC",
      "url" : "https:\/\/qducasse.github.io\/posts\/2022-04-04-trampolines\/",
      "keywords" : [ "pharo","jit","trampoline", ]
  }
</script>
<title>Cogit runtime trampolines</title>
  <meta property="og:title" content="Cogit runtime trampolines" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="Cogit trampolines cePICMissTrampoline
ceCallCogCodePopReceiverAndClassRegs
ceCallCogCodePopReceiverReg
ceCannotResumeTrampoline
ceCaptureCStackPointers
ceCheckFeaturesFunction
ceCheckForInterruptTrampoline
ceEnclosingObjectTrampoline
ceEnterCogCodePopReceiverReg
ceFetchContextInstVarTrampoline
ceFlushICache
ceFreeTrampoline
ceGetFP
ceGetSP
ceMallocTrampoline
ceMethodAbortTrampoline
ceNonLocalReturnTrampoline
cePICAbortTrampoline
cePrimReturnEnterCogCode
cePrimReturnEnterCogCodeProfiling
ceReapAndResetErrorCodeTrampoline
ceReturnToInterpreterTrampoline
ceSendMustBeBooleanAddFalseTrampoline
ceSendMustBeBooleanAddTrueTrampoline
ceStoreContextInstVarTrampoline
ceTraceBlockActivationTrampoline
ceTraceLinkedSendTrampoline
ceTraceStoreTrampoline
ceTryLockVMOwner
ceUnlockVMOwner
SimpleStackBasedCogit trampolines ceCPICMissTrampoline
ceCheckForInterruptTrampoline
ceEnclosingObjectTrampoline
ceFetchContextInstVarTrampoline
ceMethodAbortTrampoline
ceNonLocalReturnTrampoline
cePICAbortTrampoline
cePrimReturnEnterCogCode
cePrimReturnEnterCogCodeProfiling
ceReapAndResetErrorCodeTrampoline
ceStoreContextInstVarTrampoline
ceTraceBlockActivationTrampoline
ceTraceLinkedSendTrampoline
ceTraceStoreTrampoline
StackToRegisterMappingCogit trampolines ceEnclosingObjectTrampoline
ceFetchContextInstVarTrampoline
ceNonLocalReturnTrampoline
ceReapAndResetErrorCodeTrampoline
ceStoreContextInstVarTrampoline
ceTraceBlockActivationTrampoline
ceTraceLinkedSendTrampoline
ceTraceStoreTrampoline
RegisterAllocatingCogit trampolines ceCheckForInterruptTrampoline
ceSendMustBeBooleanAddFalseTrampoline
ceSendMustBeBooleanAddTrueTrampoline
Trampoline generation generateTrampolines 	&amp;#34;Generate the run-time entries and exits at the base of the native code zone and update the base." />
  <meta name="description" content="Cogit trampolines cePICMissTrampoline
ceCallCogCodePopReceiverAndClassRegs
ceCallCogCodePopReceiverReg
ceCannotResumeTrampoline
ceCaptureCStackPointers
ceCheckFeaturesFunction
ceCheckForInterruptTrampoline
ceEnclosingObjectTrampoline
ceEnterCogCodePopReceiverReg
ceFetchContextInstVarTrampoline
ceFlushICache
ceFreeTrampoline
ceGetFP
ceGetSP
ceMallocTrampoline
ceMethodAbortTrampoline
ceNonLocalReturnTrampoline
cePICAbortTrampoline
cePrimReturnEnterCogCode
cePrimReturnEnterCogCodeProfiling
ceReapAndResetErrorCodeTrampoline
ceReturnToInterpreterTrampoline
ceSendMustBeBooleanAddFalseTrampoline
ceSendMustBeBooleanAddTrueTrampoline
ceStoreContextInstVarTrampoline
ceTraceBlockActivationTrampoline
ceTraceLinkedSendTrampoline
ceTraceStoreTrampoline
ceTryLockVMOwner
ceUnlockVMOwner
SimpleStackBasedCogit trampolines ceCPICMissTrampoline
ceCheckForInterruptTrampoline
ceEnclosingObjectTrampoline
ceFetchContextInstVarTrampoline
ceMethodAbortTrampoline
ceNonLocalReturnTrampoline
cePICAbortTrampoline
cePrimReturnEnterCogCode
cePrimReturnEnterCogCodeProfiling
ceReapAndResetErrorCodeTrampoline
ceStoreContextInstVarTrampoline
ceTraceBlockActivationTrampoline
ceTraceLinkedSendTrampoline
ceTraceStoreTrampoline
StackToRegisterMappingCogit trampolines ceEnclosingObjectTrampoline
ceFetchContextInstVarTrampoline
ceNonLocalReturnTrampoline
ceReapAndResetErrorCodeTrampoline
ceStoreContextInstVarTrampoline
ceTraceBlockActivationTrampoline
ceTraceLinkedSendTrampoline
ceTraceStoreTrampoline
RegisterAllocatingCogit trampolines ceCheckForInterruptTrampoline
ceSendMustBeBooleanAddFalseTrampoline
ceSendMustBeBooleanAddTrueTrampoline
Trampoline generation generateTrampolines 	&amp;#34;Generate the run-time entries and exits at the base of the native code zone and update the base." />
  <meta property="og:locale" content="en" /><meta property="og:image" content="" />
  

  
    <style>body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:1000px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{margin:0;padding:0 1em;color:#57606a;border-left:.25em solid #d0d7de}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;font-size:100%;background-color:inherit;border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{text-align:center}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}</style>
  
  
    <style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style>
  

  

  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="Lectern">
  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel="stylesheet">
  
  

  
  
</head>


<body>
  <article class="post " id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="header-title">
    <a href="/"
      >Lectern</a
    >
  </div>
  <div class="header-subtitle">Notes and Memos, Quentin DUCASSE</div>
</header>
<div class="row end-md center-xs header-items">
  
  <div class="header-item">
    <a href="https://github.com/QDucasse" target="_blank">Github</a>
  </div>
  
  <div class="header-item">
    <a href="https://twitter.com/quentin_ducasse" target="_blank">Twitter</a>
  </div>
  
</div>
<div class="row end-xs">
   
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">Cogit runtime trampolines</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2022-04-04 00:00:00 UTC">
                04 Apr 2022
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="">@Quentin Ducasse</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <h2 id="cogit-trampolines"><code>Cogit</code> trampolines</h2>
<p><code>cePICMissTrampoline</code></p>
<p><code>ceCallCogCodePopReceiverAndClassRegs</code></p>
<p><code>ceCallCogCodePopReceiverReg</code></p>
<p><code>ceCannotResumeTrampoline</code></p>
<p><code>ceCaptureCStackPointers</code></p>
<p><code>ceCheckFeaturesFunction</code></p>
<p><code>ceCheckForInterruptTrampoline</code></p>
<p><code>ceEnclosingObjectTrampoline</code></p>
<p><code>ceEnterCogCodePopReceiverReg</code></p>
<p><code>ceFetchContextInstVarTrampoline</code></p>
<p><code>ceFlushICache</code></p>
<p><code>ceFreeTrampoline</code></p>
<p><code>ceGetFP</code></p>
<p><code>ceGetSP</code></p>
<p><code>ceMallocTrampoline</code></p>
<p><code>ceMethodAbortTrampoline</code></p>
<p><code>ceNonLocalReturnTrampoline</code></p>
<p><code>cePICAbortTrampoline</code></p>
<p><code>cePrimReturnEnterCogCode</code></p>
<p><code>cePrimReturnEnterCogCodeProfiling</code></p>
<p><code>ceReapAndResetErrorCodeTrampoline</code></p>
<p><code>ceReturnToInterpreterTrampoline</code></p>
<p><code>ceSendMustBeBooleanAddFalseTrampoline</code></p>
<p><code>ceSendMustBeBooleanAddTrueTrampoline</code></p>
<p><code>ceStoreContextInstVarTrampoline</code></p>
<p><code>ceTraceBlockActivationTrampoline</code></p>
<p><code>ceTraceLinkedSendTrampoline</code></p>
<p><code>ceTraceStoreTrampoline</code></p>
<p><code>ceTryLockVMOwner</code></p>
<p><code>ceUnlockVMOwner</code></p>
<h2 id="simplestackbasedcogit-trampolines"><code>SimpleStackBasedCogit</code> trampolines</h2>
<p><code>ceCPICMissTrampoline</code></p>
<p><code>ceCheckForInterruptTrampoline</code></p>
<p><code>ceEnclosingObjectTrampoline</code></p>
<p><code>ceFetchContextInstVarTrampoline</code></p>
<p><code>ceMethodAbortTrampoline</code></p>
<p><code>ceNonLocalReturnTrampoline</code></p>
<p><code>cePICAbortTrampoline</code></p>
<p><code>cePrimReturnEnterCogCode</code></p>
<p><code>cePrimReturnEnterCogCodeProfiling</code></p>
<p><code>ceReapAndResetErrorCodeTrampoline</code></p>
<p><code>ceStoreContextInstVarTrampoline</code></p>
<p><code>ceTraceBlockActivationTrampoline</code></p>
<p><code>ceTraceLinkedSendTrampoline</code></p>
<p><code>ceTraceStoreTrampoline</code></p>
<h2 id="stacktoregistermappingcogit-trampolines"><code>StackToRegisterMappingCogit</code> trampolines</h2>
<p><code>ceEnclosingObjectTrampoline</code></p>
<p><code>ceFetchContextInstVarTrampoline</code></p>
<p><code>ceNonLocalReturnTrampoline</code></p>
<p><code>ceReapAndResetErrorCodeTrampoline</code></p>
<p><code>ceStoreContextInstVarTrampoline</code></p>
<p><code>ceTraceBlockActivationTrampoline</code></p>
<p><code>ceTraceLinkedSendTrampoline</code></p>
<p><code>ceTraceStoreTrampoline</code></p>
<h2 id="registerallocatingcogit-trampolines"><code>RegisterAllocatingCogit</code> trampolines</h2>
<p><code>ceCheckForInterruptTrampoline</code></p>
<p><code>ceSendMustBeBooleanAddFalseTrampoline</code></p>
<p><code>ceSendMustBeBooleanAddTrueTrampoline</code></p>
<h2 id="trampoline-generation">Trampoline generation</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-smalltalk" data-lang="smalltalk"><span style="display:flex;"><span><span style="color:#a6e22e">generateTrampolines</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">&#34;Generate the run-time entries and exits at the base of the native code zone and update the base.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 Read the class-side method trampolines for documentation on the various trampolines&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">|</span> methodZoneStart <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	methodZoneStart <span style="color:#f92672">:=</span> methodZoneBase.
</span></span><span style="display:flex;"><span>	methodLabel <span style="color:#a6e22e">address:</span> methodZoneStart.
</span></span><span style="display:flex;"><span>	self <span style="color:#a6e22e">allocateOpcodes:</span> <span style="color:#ae81ff">80</span> <span style="color:#a6e22e">bytecodes:</span> <span style="color:#ae81ff">0</span>.
</span></span><span style="display:flex;"><span>	hasYoungReferent <span style="color:#f92672">:=</span> false.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	self
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">enableCodeZoneWriteDuring:</span> [ 	
</span></span><span style="display:flex;"><span>			objectRepresentation <span style="color:#a6e22e">maybeGenerateSelectorIndexDereferenceRoutine</span>.
</span></span><span style="display:flex;"><span>			self <span style="color:#a6e22e">generateSendTrampolines</span>.                        <span style="color:#75715e">&#34;Send variations&#34;</span>
</span></span><span style="display:flex;"><span>			self <span style="color:#a6e22e">generateMissAbortTrampolines</span>.                   <span style="color:#75715e">&#34;PIC Miss/Abort&#34;</span>
</span></span><span style="display:flex;"><span>			objectRepresentation <span style="color:#a6e22e">generateObjectRepresentationTrampolines</span>.
</span></span><span style="display:flex;"><span>			self <span style="color:#a6e22e">generateRunTimeTrampolines</span>.                     <span style="color:#75715e">&#34;Runtime&#34;</span>
</span></span><span style="display:flex;"><span>			self <span style="color:#a6e22e">generateEnilopmarts</span>.                            <span style="color:#75715e">&#34;Enilopmarts (machine code to C)&#34;</span>
</span></span><span style="display:flex;"><span>			self <span style="color:#a6e22e">generateTracingTrampolines</span>.                     <span style="color:#75715e">&#34;Tracing methods&#34;</span>
</span></span><span style="display:flex;"><span>			self <span style="color:#a6e22e">recordGeneratedRunTime:</span> <span style="color:#e6db74">&#39;methodZoneBase&#39;</span> <span style="color:#a6e22e">address:</span> methodZoneBase]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flushingCacheWith:</span> [ self <span style="color:#a6e22e">flushICacheFrom:</span> methodZoneStart <span style="color:#a6e22e">asUnsignedInteger</span> <span style="color:#a6e22e">to:</span> methodZoneBase <span style="color:#a6e22e">asUnsignedInteger</span> ].
</span></span></code></pre></div><h4 id="selector-dereference">Selector Dereference</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x6a03000: ceGetFP
</span></span><span style="display:flex;"><span>0x6a03008: ceGetSP
</span></span><span style="display:flex;"><span>0x6a03010: ceCaptureCStackPointers
</span></span><span style="display:flex;"><span>0x6a03080: ceDereferenceSelectorIndex
</span></span></code></pre></div><h4 id="send-trampolines">Send trampolines</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-smalltalk" data-lang="smalltalk"><span style="display:flex;"><span><span style="color:#a6e22e">generateSendTrampolines</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0</span> <span style="color:#a6e22e">to:</span> <span style="color:#a6e22e">NumSendTrampolines</span> <span style="color:#a6e22e">-</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">do:</span>
</span></span><span style="display:flex;"><span>		[<span style="color:#f92672">:</span>numArgs<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>		ordinarySendTrampolines
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">at:</span> numArgs
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">put:</span> (self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceSend:super:to:numArgs:</span>
</span></span><span style="display:flex;"><span>					  <span style="color:#a6e22e">called:</span> (self <span style="color:#a6e22e">trampolineName:</span> <span style="color:#e6db74">&#39;ceSend&#39;</span> <span style="color:#a6e22e">numArgs:</span> numArgs)
</span></span><span style="display:flex;"><span>					  <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ClassReg</span>
</span></span><span style="display:flex;"><span>					  <span style="color:#a6e22e">arg:</span> (self <span style="color:#a6e22e">trampolineArgConstant:</span> false)
</span></span><span style="display:flex;"><span>					  <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>					  <span style="color:#a6e22e">arg:</span> (self <span style="color:#a6e22e">numArgsOrSendNumArgsReg:</span> numArgs))].
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">&#34;Generate these in the middle so they are within [firstSend, lastSend].&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">BytecodeSetHasDirectedSuperSend</span> ifTrue:
</span></span><span style="display:flex;"><span>		[<span style="color:#ae81ff">0</span> <span style="color:#a6e22e">to:</span> <span style="color:#a6e22e">NumSendTrampolines</span> <span style="color:#a6e22e">-</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">do:</span>
</span></span><span style="display:flex;"><span>			[<span style="color:#f92672">:</span>numArgs<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>			directedSuperSendTrampolines
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">at:</span> numArgs
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">put:</span> (self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceSend:above:to:numArgs:</span>
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">called:</span> (self <span style="color:#a6e22e">trampolineName:</span> <span style="color:#e6db74">&#39;ceDirectedSuperSend&#39;</span> <span style="color:#a6e22e">numArgs:</span> numArgs)
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ClassReg</span>
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">TempReg</span>
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">arg:</span> (self <span style="color:#a6e22e">numArgsOrSendNumArgsReg:</span> numArgs)).
</span></span><span style="display:flex;"><span>			directedSuperBindingSendTrampolines
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">at:</span> numArgs
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">put:</span> (self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceSend:aboveClassBinding:to:numArgs:</span>
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">called:</span> (self <span style="color:#a6e22e">trampolineName:</span> <span style="color:#e6db74">&#39;ceDirectedSuperBindingSend&#39;</span> <span style="color:#a6e22e">numArgs:</span> numArgs)
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ClassReg</span>
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">TempReg</span>
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>						  <span style="color:#a6e22e">arg:</span> (self <span style="color:#a6e22e">numArgsOrSendNumArgsReg:</span> numArgs))]].
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0</span> <span style="color:#a6e22e">to:</span> <span style="color:#a6e22e">NumSendTrampolines</span> <span style="color:#a6e22e">-</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">do:</span>
</span></span><span style="display:flex;"><span>		[<span style="color:#f92672">:</span>numArgs<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>		superSendTrampolines
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">at:</span> numArgs
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">put:</span> (self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceSend:super:to:numArgs:</span>
</span></span><span style="display:flex;"><span>					  <span style="color:#a6e22e">called:</span> (self <span style="color:#a6e22e">trampolineName:</span> <span style="color:#e6db74">&#39;ceSuperSend&#39;</span> <span style="color:#a6e22e">numArgs:</span> numArgs)
</span></span><span style="display:flex;"><span>					  <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ClassReg</span>
</span></span><span style="display:flex;"><span>					  <span style="color:#a6e22e">arg:</span> (self <span style="color:#a6e22e">trampolineArgConstant:</span> true)
</span></span><span style="display:flex;"><span>					  <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>					  <span style="color:#a6e22e">arg:</span> (self <span style="color:#a6e22e">numArgsOrSendNumArgsReg:</span> numArgs))].
</span></span><span style="display:flex;"><span>	firstSend <span style="color:#f92672">:=</span> ordinarySendTrampolines <span style="color:#a6e22e">at:</span> <span style="color:#ae81ff">0</span>.
</span></span><span style="display:flex;"><span>	lastSend <span style="color:#f92672">:=</span> superSendTrampolines <span style="color:#a6e22e">at:</span> <span style="color:#a6e22e">NumSendTrampolines</span> <span style="color:#a6e22e">-</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x6a031c0: ceSend0Args
</span></span><span style="display:flex;"><span>0x6a03250: ceSend1Args
</span></span><span style="display:flex;"><span>0x6a032e8: ceSend2Args
</span></span><span style="display:flex;"><span>0x6a03388: ceSendNArgs
</span></span><span style="display:flex;"><span>0x6a03410: ceDirectedSuperSend0Args
</span></span><span style="display:flex;"><span>0x6a034a0: ceDirectedSuperBindingSend0Args
</span></span><span style="display:flex;"><span>0x6a03530: ceDirectedSuperSend1Args
</span></span><span style="display:flex;"><span>0x6a035c8: ceDirectedSuperBindingSend1Args
</span></span><span style="display:flex;"><span>0x6a03660: ceDirectedSuperSend2Args
</span></span><span style="display:flex;"><span>0x6a03700: ceDirectedSuperBindingSend2Args
</span></span><span style="display:flex;"><span>0x6a037a0: ceDirectedSuperSendNArgs
</span></span><span style="display:flex;"><span>0x6a03828: ceDirectedSuperBindingSendNArgs
</span></span><span style="display:flex;"><span>0x6a038b0: ceSuperSend0Args
</span></span><span style="display:flex;"><span>0x6a03940: ceSuperSend1Args
</span></span><span style="display:flex;"><span>0x6a039d8: ceSuperSend2Args
</span></span><span style="display:flex;"><span>0x6a03a78: ceSuperSendNArgs
</span></span></code></pre></div><h4 id="pic-missabort-trampolines">PIC Miss/Abort trampolines</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-smalltalk" data-lang="smalltalk"><span style="display:flex;"><span><span style="color:#a6e22e">generateMissAbortTrampolines</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">&#34;Generate the run-time entries for the various method and PIC entry misses and aborts.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 Read the class-side method trampolines for documentation on the various trampolines&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0</span> <span style="color:#a6e22e">to:</span> self <span style="color:#a6e22e">numRegArgs</span> <span style="color:#a6e22e">+</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">do:</span>
</span></span><span style="display:flex;"><span>		[<span style="color:#f92672">:</span>numArgs<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>		methodAbortTrampolines
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">at:</span> numArgs
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">put:</span> (self <span style="color:#a6e22e">genMethodAbortTrampolineFor:</span> numArgs)].
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0</span> <span style="color:#a6e22e">to:</span> self <span style="color:#a6e22e">numRegArgs</span> <span style="color:#a6e22e">+</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">do:</span>
</span></span><span style="display:flex;"><span>		[<span style="color:#f92672">:</span>numArgs<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>		picAbortTrampolines
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">at:</span> numArgs
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">put:</span> (self <span style="color:#a6e22e">genPICAbortTrampolineFor:</span> numArgs)].
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0</span> <span style="color:#a6e22e">to:</span> self <span style="color:#a6e22e">numRegArgs</span> <span style="color:#a6e22e">+</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">do:</span>
</span></span><span style="display:flex;"><span>		[<span style="color:#f92672">:</span>numArgs<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>		picMissTrampolines
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">at:</span> numArgs
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">put:</span> (self <span style="color:#a6e22e">genPICMissTrampolineFor:</span> numArgs)].
</span></span><span style="display:flex;"><span>	ceReapAndResetErrorCodeTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceReapAndResetErrorCodeFor:</span>
</span></span><span style="display:flex;"><span>												<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceReapAndResetErrorCodeTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>												<span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ClassReg</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x6a03b00: ceMethodAbort0Args
</span></span><span style="display:flex;"><span>0x6a03be0: ceMethodAbort1Args
</span></span><span style="display:flex;"><span>0x6a03cc8: ceMethodAbort2Args
</span></span><span style="display:flex;"><span>0x6a03db8: ceMethodAbortNArgs
</span></span><span style="display:flex;"><span>0x6a03e88: cePICAbort0Args
</span></span><span style="display:flex;"><span>0x6a03f68: cePICAbort1Args
</span></span><span style="display:flex;"><span>0x6a04050: cePICAbort2Args
</span></span><span style="display:flex;"><span>0x6a04140: cePICAbortNArgs
</span></span><span style="display:flex;"><span>0x6a04210: cePICMiss0Args
</span></span><span style="display:flex;"><span>0x6a04280: cePICMiss1Args
</span></span><span style="display:flex;"><span>0x6a042f8: cePICMiss2Args
</span></span><span style="display:flex;"><span>0x6a04378: cePICMissNArgs
</span></span><span style="display:flex;"><span>0x6a043e0: ceReapAndResetErrorCodeTrampoline
</span></span></code></pre></div><h4 id="object-representation-trampolines">Object Representation trampolines</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-smalltalk" data-lang="smalltalk"><span style="display:flex;"><span><span style="color:#a6e22e">generateObjectRepresentationTrampolines</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">&#34;Do the store check.  Answer the argument for the benefit of the code generator;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 ReceiverResultReg may be caller-saved and hence smashed by this call.  Answering
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 it allows the code generator to reload ReceiverResultReg cheaply.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 In Spur the only thing we leave to the run-time is adding the receiver to the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 remembered set and setting its isRemembered bit.&#34;</span>
</span></span><span style="display:flex;"><span>	self
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cppIf:</span> <span style="color:#a6e22e">IMMUTABILITY</span>
</span></span><span style="display:flex;"><span>		ifTrue:
</span></span><span style="display:flex;"><span>			[self <span style="color:#a6e22e">cCode:</span> [] <span style="color:#a6e22e">inSmalltalk:</span>
</span></span><span style="display:flex;"><span>				[ceStoreTrampolines <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CArrayAccessor</span> <span style="color:#a6e22e">on:</span> (<span style="color:#a6e22e">Array</span> <span style="color:#a6e22e">new:</span> <span style="color:#a6e22e">NumStoreTrampolines</span>)].
</span></span><span style="display:flex;"><span>			 <span style="color:#ae81ff">0</span> <span style="color:#a6e22e">to:</span> <span style="color:#a6e22e">NumStoreTrampolines</span> <span style="color:#a6e22e">-</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">do:</span>
</span></span><span style="display:flex;"><span>				[<span style="color:#f92672">:</span>instVarIndex <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>				 ceStoreTrampolines
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">at:</span> instVarIndex
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">put:</span> (self
</span></span><span style="display:flex;"><span>							<span style="color:#a6e22e">genStoreTrampolineCalled:</span> (cogit
</span></span><span style="display:flex;"><span>								<span style="color:#a6e22e">trampolineName:</span> <span style="color:#e6db74">&#39;ceStoreTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>								<span style="color:#a6e22e">numArgs:</span> instVarIndex
</span></span><span style="display:flex;"><span>								<span style="color:#a6e22e">limit:</span> <span style="color:#a6e22e">NumStoreTrampolines</span> <span style="color:#a6e22e">-</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>							<span style="color:#a6e22e">instVarIndex:</span> instVarIndex)]].
</span></span><span style="display:flex;"><span>	ceNewHashTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genNewHashTrampoline:</span> false <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceNewHash&#39;</span>.
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SistaVM</span> ifTrue: [ceInlineNewHashTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genNewHashTrampoline:</span> true  <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceInlineNewHash&#39;</span>].
</span></span><span style="display:flex;"><span>	ceStoreCheckTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genStoreCheckTrampoline</span>.
</span></span><span style="display:flex;"><span>	ceStoreCheckContextReceiverTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genStoreCheckContextReceiverTrampoline</span>.
</span></span><span style="display:flex;"><span>	ceScheduleScavengeTrampoline <span style="color:#f92672">:=</span> cogit
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceScheduleScavenge</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceScheduleScavengeTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">regsToSave:</span> <span style="color:#a6e22e">CallerSavedRegisterMask</span>.
</span></span><span style="display:flex;"><span>	ceSmallActiveContextInMethodTrampoline <span style="color:#f92672">:=</span> self
</span></span><span style="display:flex;"><span>    	<span style="color:#a6e22e">genActiveContextTrampolineLarge:</span> false
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">inBlock:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceSmallMethodContext&#39;</span>.
</span></span><span style="display:flex;"><span>	ceSmallActiveContextInBlockTrampoline <span style="color:#f92672">:=</span> self
</span></span><span style="display:flex;"><span>    	<span style="color:#a6e22e">genActiveContextTrampolineLarge:</span> false
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">inBlock:</span> <span style="color:#a6e22e">InVanillaBlock</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceSmallBlockContext&#39;</span>.
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SistaV1BytecodeSet</span> ifTrue:
</span></span><span style="display:flex;"><span>		[ceSmallActiveContextInFullBlockTrampoline <span style="color:#f92672">:=</span> self
</span></span><span style="display:flex;"><span>        	<span style="color:#a6e22e">genActiveContextTrampolineLarge:</span> false
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">inBlock:</span> <span style="color:#a6e22e">InFullBlock</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceSmallFullBlockContext&#39;</span>].
</span></span><span style="display:flex;"><span>	ceLargeActiveContextInMethodTrampoline <span style="color:#f92672">:=</span> self
</span></span><span style="display:flex;"><span>    	<span style="color:#a6e22e">genActiveContextTrampolineLarge:</span> true
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">inBlock:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceLargeMethodContext&#39;</span>.
</span></span><span style="display:flex;"><span>	ceLargeActiveContextInBlockTrampoline <span style="color:#f92672">:=</span> self
</span></span><span style="display:flex;"><span>    	<span style="color:#a6e22e">genActiveContextTrampolineLarge:</span> true
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">inBlock:</span> <span style="color:#a6e22e">InVanillaBlock</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceLargeBlockContext&#39;</span>.
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SistaV1BytecodeSet</span> ifTrue:
</span></span><span style="display:flex;"><span>		[ceLargeActiveContextInFullBlockTrampoline <span style="color:#f92672">:=</span> self
</span></span><span style="display:flex;"><span>        	<span style="color:#a6e22e">genActiveContextTrampolineLarge:</span> true
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">inBlock:</span> <span style="color:#a6e22e">InFullBlock</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceLargeFullBlockContext&#39;</span>].
</span></span></code></pre></div><pre tabindex="0"><code>0x6a04448: ceStoreTrampoline0Args
0x6a04538: ceStoreTrampoline1Args
0x6a04628: ceStoreTrampoline2Args
0x6a04718: ceStoreTrampoline3Args
0x6a04808: ceStoreTrampolineNArgs
0x6a048f8: ceNewHash
0x6a04960: ceStoreCheckTrampoline
0x6a049e8: ceStoreCheckContextReceiver
0x6a04a90: ceScheduleScavengeTrampoline
0x6a04b10: ceSmallMethodContext
0x6a04ec8: ceSmallBlockContext
0x6a052d0: ceSmallFullBlockContext
0x6a056b0: ceLargeMethodContext
0x6a05a68: ceLargeBlockContext
0x6a05e70: ceLargeFullBlockContext
</code></pre><h4 id="runtime-trampolines">Runtime trampolines</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-smalltalk" data-lang="smalltalk"><span style="display:flex;"><span><span style="color:#a6e22e">generateRunTimeTrampolines</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">&#34;Generate the run-time entries at the base of the native code zone and update the base.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ceSendMustBeBooleanAddFalseTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genMustBeBooleanTrampolineFor:</span> objectMemory <span style="color:#a6e22e">falseObject</span>
</span></span><span style="display:flex;"><span>												  <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceSendMustBeBooleanAddFalseTrampoline&#39;</span>.
</span></span><span style="display:flex;"><span>	ceSendMustBeBooleanAddTrueTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genMustBeBooleanTrampolineFor:</span> objectMemory <span style="color:#a6e22e">trueObject</span>
</span></span><span style="display:flex;"><span>												 <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceSendMustBeBooleanAddTrueTrampoline&#39;</span>.
</span></span><span style="display:flex;"><span>	ceNonLocalReturnTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genNonLocalReturnTrampoline</span>.
</span></span><span style="display:flex;"><span>	ceCheckForInterruptTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genCheckForInterruptsTrampoline</span>.
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">&#34;Neither of the context inst var access trampolines save registers.  Their operation could cause
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 arbitrary update of stack frames, so the assumption is that callers flush the stack before calling
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 the context inst var access trampolines, and that everything except the result is dead afterwards.&#34;</span>
</span></span><span style="display:flex;"><span>	ceFetchContextInstVarTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceContext:instVar:</span>
</span></span><span style="display:flex;"><span>											<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceFetchContextInstVarTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>											<span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>											<span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">SendNumArgsReg</span>
</span></span><span style="display:flex;"><span>											<span style="color:#a6e22e">result:</span> <span style="color:#a6e22e">SendNumArgsReg</span>.
</span></span><span style="display:flex;"><span>	ceStoreContextInstVarTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceContext:instVar:value:</span>
</span></span><span style="display:flex;"><span>											<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceStoreContextInstVarTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>											<span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>											<span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">SendNumArgsReg</span>
</span></span><span style="display:flex;"><span>											<span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ClassReg</span>
</span></span><span style="display:flex;"><span>											<span style="color:#a6e22e">result:</span> <span style="color:#a6e22e">ReceiverResultReg</span>. <span style="color:#75715e">&#34;to keep ReceiverResultReg live.&#34;</span>.
</span></span><span style="display:flex;"><span>	ceCannotResumeTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceCannotResume</span>
</span></span><span style="display:flex;"><span>									 <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceCannotResumeTrampoline&#39;</span>.
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">&#34;These two are unusual; they are reached by return instructions.&#34;</span>
</span></span><span style="display:flex;"><span>	ceBaseFrameReturnTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genReturnTrampolineFor:</span> <span style="color:#e6db74">#ceBaseFrameReturn:</span>
</span></span><span style="display:flex;"><span>										<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceBaseFrameReturnTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>										<span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>.
</span></span><span style="display:flex;"><span>	ceReturnToInterpreterTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genReturnTrampolineFor:</span> <span style="color:#e6db74">#ceReturnToInterpreter:</span>
</span></span><span style="display:flex;"><span>											<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceReturnToInterpreterTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>											<span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>.
</span></span><span style="display:flex;"><span>	ceMallocTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceMalloc:</span>
</span></span><span style="display:flex;"><span>							   <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceMallocTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>							   <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>						       <span style="color:#a6e22e">result:</span> <span style="color:#a6e22e">TempReg</span>.
</span></span><span style="display:flex;"><span>	ceFreeTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceFree:</span>
</span></span><span style="display:flex;"><span>						 	 <span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceFreeTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>							 <span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x6a06250: ceSendMustBeBooleanAddFalseTrampoline
</span></span><span style="display:flex;"><span>0x6a062e8: ceSendMustBeBooleanAddTrueTrampoline
</span></span><span style="display:flex;"><span>0x6a06380: ceNonLocalReturnTrampoline
</span></span><span style="display:flex;"><span>0x6a063d8: ceCheckForInterruptsTrampoline
</span></span><span style="display:flex;"><span>0x6a06430: ceFetchContextInstVarTrampoline
</span></span><span style="display:flex;"><span>0x6a064a0: ceStoreContextInstVarTrampoline
</span></span><span style="display:flex;"><span>0x6a06510: ceCannotResumeTrampoline
</span></span><span style="display:flex;"><span>0x6a06570: ceBaseFrameReturnTrampoline
</span></span><span style="display:flex;"><span>0x6a065c8: ceReturnToInterpreterTrampoline
</span></span><span style="display:flex;"><span>0x6a06620: ceMallocTrampoline
</span></span><span style="display:flex;"><span>0x6a06688: ceFreeTrampoline
</span></span></code></pre></div><h5 id="enilopmarts-reverse-trampolines">Enilopmarts (reverse trampolines)</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-smalltalk" data-lang="smalltalk"><span style="display:flex;"><span><span style="color:#a6e22e">generateEnilopmarts</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">&#34;Enilopmarts transfer control from C into machine code (backwards trampolines).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 Override to add version for generic and PIC-specific entry with reg args.&#34;</span>
</span></span><span style="display:flex;"><span>	super <span style="color:#a6e22e">generateEnilopmarts</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	self <span style="color:#a6e22e">cppIf:</span> <span style="color:#a6e22e">Debug</span>
</span></span><span style="display:flex;"><span>		ifTrue:
</span></span><span style="display:flex;"><span>			[realCECallCogCodePopReceiverArg0Regs <span style="color:#f92672">:=</span>
</span></span><span style="display:flex;"><span>				self <span style="color:#a6e22e">genEnilopmartFor:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">and:</span> <span style="color:#a6e22e">Arg0Reg</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">forCall:</span> true
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;realCECallCogCodePopReceiverArg0Regs&#39;</span>.
</span></span><span style="display:flex;"><span>			 ceCallCogCodePopReceiverArg0Regs <span style="color:#f92672">:=</span> <span style="color:#e6db74">#callCogCodePopReceiverArg0Regs</span>.
</span></span><span style="display:flex;"><span>			 realCECallCogCodePopReceiverArg1Arg0Regs <span style="color:#f92672">:=</span>
</span></span><span style="display:flex;"><span>				self <span style="color:#a6e22e">genEnilopmartFor:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">and:</span> <span style="color:#a6e22e">Arg0Reg</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">and:</span> <span style="color:#a6e22e">Arg1Reg</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">forCall:</span> true
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;realCECallCogCodePopReceiverArg1Arg0Regs&#39;</span>.
</span></span><span style="display:flex;"><span>			 ceCallCogCodePopReceiverArg1Arg0Regs <span style="color:#f92672">:=</span> <span style="color:#e6db74">#callCogCodePopReceiverArg1Arg0Regs</span>]
</span></span><span style="display:flex;"><span>		ifFalse:
</span></span><span style="display:flex;"><span>			[ceCallCogCodePopReceiverArg0Regs <span style="color:#f92672">:=</span>
</span></span><span style="display:flex;"><span>				self <span style="color:#a6e22e">genEnilopmartFor:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">and:</span> <span style="color:#a6e22e">Arg0Reg</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">forCall:</span> true
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceCallCogCodePopReceiverArg0Regs&#39;</span>.
</span></span><span style="display:flex;"><span>			 ceCallCogCodePopReceiverArg1Arg0Regs <span style="color:#f92672">:=</span>
</span></span><span style="display:flex;"><span>				self <span style="color:#a6e22e">genEnilopmartFor:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">and:</span> <span style="color:#a6e22e">Arg0Reg</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">and:</span> <span style="color:#a6e22e">Arg1Reg</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">forCall:</span> true
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceCallCogCodePopReceiverArg1Arg0Regs&#39;</span>].
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">&#34;These are special versions of the ceCallCogCodePopReceiverAndClassRegs enilopmart that also
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 pop register args from the stack to undo the pushing of register args in the abort/miss trampolines.&#34;</span>
</span></span><span style="display:flex;"><span>	ceCall0ArgsPIC <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genCallPICEnilopmartNumArgs:</span> <span style="color:#ae81ff">0</span>.
</span></span><span style="display:flex;"><span>	self <span style="color:#a6e22e">numRegArgs</span> <span style="color:#a6e22e">&gt;=</span> <span style="color:#ae81ff">1</span> ifTrue:
</span></span><span style="display:flex;"><span>		[ceCall1ArgsPIC <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genCallPICEnilopmartNumArgs:</span> <span style="color:#ae81ff">1</span>.
</span></span><span style="display:flex;"><span>		 self <span style="color:#a6e22e">numRegArgs</span> <span style="color:#a6e22e">&gt;=</span> <span style="color:#ae81ff">2</span> ifTrue:
</span></span><span style="display:flex;"><span>			[ceCall2ArgsPIC <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">genCallPICEnilopmartNumArgs:</span> <span style="color:#ae81ff">2</span>.
</span></span><span style="display:flex;"><span>			 self <span style="color:#a6e22e">assert:</span> self <span style="color:#a6e22e">numRegArgs</span> <span style="color:#a6e22e">=</span> <span style="color:#ae81ff">2</span>]]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x6a066f0: ceEnterCogCodePopReceiverReg
</span></span><span style="display:flex;"><span>0x6a06720: ceCallCogCodePopReceiverReg
</span></span><span style="display:flex;"><span>0x6a06758: ceCallCogCodePopReceiverAndClassRegs
</span></span><span style="display:flex;"><span>0x6a06798: cePrimReturnEnterCogCode
</span></span><span style="display:flex;"><span>0x6a06838: cePrimReturnEnterCogCodeProfiling
</span></span><span style="display:flex;"><span>0x6a06928: ceCallCogCodePopReceiverArg0Regs
</span></span><span style="display:flex;"><span>0x6a06968: ceCallCogCodePopReceiverArg1Arg0Regs
</span></span><span style="display:flex;"><span>0x6a069b0: ceCallPIC0Args
</span></span><span style="display:flex;"><span>0x6a069f0: ceCallPIC1Args
</span></span><span style="display:flex;"><span>0x6a06a38: ceCallPIC2Args
</span></span></code></pre></div><h4 id="tracing-trampolines">Tracing trampolines</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-smalltalk" data-lang="smalltalk"><span style="display:flex;"><span><span style="color:#a6e22e">generateTracingTrampolines</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">&#34;Generate trampolines for tracing.  In the simulator we can save a lot of time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 and avoid noise instructions in the lastNInstructions log by short-cutting these
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 trampolines, but we need them in the real vm.&#34;</span>
</span></span><span style="display:flex;"><span>	ceTraceLinkedSendTrampoline <span style="color:#f92672">:=</span>
</span></span><span style="display:flex;"><span>		self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceTraceLinkedSend:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceTraceLinkedSendTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">regsToSave:</span> <span style="color:#a6e22e">CallerSavedRegisterMask</span>.
</span></span><span style="display:flex;"><span>	ceTraceBlockActivationTrampoline <span style="color:#f92672">:=</span>
</span></span><span style="display:flex;"><span>		self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceTraceBlockActivation</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceTraceBlockActivationTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">regsToSave:</span> <span style="color:#a6e22e">CallerSavedRegisterMask</span>..
</span></span><span style="display:flex;"><span>	ceTraceStoreTrampoline <span style="color:#f92672">:=</span>
</span></span><span style="display:flex;"><span>		self <span style="color:#a6e22e">genTrampolineFor:</span> <span style="color:#e6db74">#ceTraceStoreOf:into:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">called:</span> <span style="color:#e6db74">&#39;ceTraceStoreTrampoline&#39;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ClassReg</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">arg:</span> <span style="color:#a6e22e">ReceiverResultReg</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">regsToSave:</span> <span style="color:#a6e22e">CallerSavedRegisterMask</span>..
</span></span><span style="display:flex;"><span>	self <span style="color:#a6e22e">cCode:</span> [] <span style="color:#a6e22e">inSmalltalk:</span>
</span></span><span style="display:flex;"><span>		[ceTraceLinkedSendTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">simulatedTrampolineFor:</span> <span style="color:#e6db74">#ceShortCutTraceLinkedSend:</span>.
</span></span><span style="display:flex;"><span>		 ceTraceBlockActivationTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">simulatedTrampolineFor:</span> <span style="color:#e6db74">#ceShortCutTraceBlockActivation:</span>.
</span></span><span style="display:flex;"><span>		 ceTraceStoreTrampoline <span style="color:#f92672">:=</span> self <span style="color:#a6e22e">simulatedTrampolineFor:</span> <span style="color:#e6db74">#ceShortCutTraceStore:</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x6a06a88: ceTraceLinkedSendTrampoline
</span></span><span style="display:flex;"><span>0x6a06b10: ceTraceBlockActivationTrampoline
</span></span><span style="display:flex;"><span>0x6a06b90: ceTraceStoreTrampoline
</span></span></code></pre></div>
        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
            <div class="post-tags">
              <a href="/tags/pharo/">
                pharo
              </a>
            </div>
            
            <div class="post-tags">
              <a href="/tags/jit/">
                jit
              </a>
            </div>
            
            <div class="post-tags">
              <a href="/tags/trampoline/">
                trampoline
              </a>
            </div>
            
          </div>
        </div>
        
          <div class="row">
            <div class="col-xs-12">
              
            </div>
          </div>

          

<div class="related-content">
  <h3>Related Posts</h3>
  <ul>
    
    <li><a href="/posts/2022-03-10-jit_debug/">Debugging Pharo JIT code in gdb</a></li>
    
  </ul>
</div>



          
          
          <div style="height: 50px;"></div>
          
        

        <div class="site-footer">
  
  
</div>

      </div>
    </div>
  </article>

  

<script>
  
  
    
    
  
</script>

  

</body>

</html>